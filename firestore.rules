rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // 白名單集合 - 只有管理員可以修改
    match /whitelists/{email} {
      allow read: if request.auth != null && request.auth.token.email == email;
      allow write: if false; // 只能通過 Admin SDK 修改
    }
    
    // 檢查用戶是否在白名單中的函數
    function isWhitelisted(email) {
      return exists(/databases/$(database)/documents/whitelists/$(email));
    }
    
    // 用戶專案數據 - 只有認證且在白名單中的用戶可以寫入
    match /users/{userId}/projects/{projectId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && 
                      request.auth.uid == userId && 
                      isWhitelisted(request.auth.token.email);
      
      // 專案子集合（rounds等）
      match /{document=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && 
                        request.auth.uid == userId && 
                        isWhitelisted(request.auth.token.email);
      }
    }
    
    // 用戶配置檔案 - 只有認證且在白名單中的用戶可以寫入
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && 
                      request.auth.uid == userId && 
                      isWhitelisted(request.auth.token.email);
      
      // 用戶配置檔案子集合
      match /profile/{document=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && 
                        request.auth.uid == userId && 
                        isWhitelisted(request.auth.token.email);
      }
      
      // 用戶專案集合
      match /projects/{document=**} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if request.auth != null && 
                        request.auth.uid == userId && 
                        isWhitelisted(request.auth.token.email);
      }
    }
    
    // 公開或共享的數據（如果需要）
    match /shared/{document=**} {
      allow read: if request.auth != null;
    }
    
    // 分析數據集合 - 允許所有用戶（包括非白名單和訪客）寫入
    match /analytics/data/{collection}/{document} {
      // 允許所有人寫入分析數據（包括訪客）
      allow write: if true;
      // 只允許認證用戶讀取
      allow read: if request.auth != null;
      
      // 允許子集合的讀寫
      match /{subcollection=**} {
        allow write: if true;
        allow read: if request.auth != null;
      }
    }
    
    // 測試連接路徑（僅開發環境）
    match /test/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
